
# 使用文档

这是一个为 AstrBot 设计的 IP 代理插件，它能将远程 HTTP 代理 API 转换为本地代理服务，并实现自动 IP 切换和验证。

**插件特性：**

* **独立指令：** 所有功能均通过独立的、易于记忆的指令进行操作。
* **API兼容：** 兼容所有 HTTP 代理的 IP 提取 API ,请选择`txt`数据格式，并且每次提取 IP 数量设置为1
* **在线配置：** 可通过指令动态修改核心配置。
* **后台配置：** 也支持在 AstrBot 管理后台进行可视化配置。
* **权限控制：** 所有操作指令均需要 Astrbot 管理员权限。

## 安装方法

1.  **进入插件目录：** 进入您的 AstrBot 的 `data/plugins` 目录
2.  **克隆仓库** 使用git clone来克隆本插件
```bash
git clone [https://github.com/timetetng/astrbot_plugin_ip_proxy.git](https://github.com/timetetng/astrbot_plugin_ip_proxy.git)
````

3.  **重启 AstrBot：** 重启您的 AstrBot 服务以加载插件。

## 配置方法

您可以通过两种方式配置此插件，指令配置的优先级更高。

  * **后台配置（推荐用于首次配置）：**

    1.  启动 AstrBot 后，访问其 Web 管理界面。
    2.  在插件管理中找到 `astrbot_plugin_ip_proxy`。
    3.  在表单中填写您的 API 地址 等信息并保存。

  * **指令配置（推荐用于动态修改）：**

      * 在聊天中向机器人发送指令来修改配置，详见下文指令列表。

## 配置说明

  * `start_on_load`
    描述: 控制插件是否在 AstrBot 启动时自动开启代理服务。
    说明:

      * `true`: 插件将在 AstrBot 启动时自动运行代理服务，无需手动发送开启指令。
      * `false`: 需要手动发送指令来启动代理服务。

  * `api_url`
    类型: `string`
    描述: 用于获取代理 IP 的 API 地址。
    说明:

      * 请务必将 `"api_url` 替换为您在代理服务提供商处获得的有效 API 地址。
      * 目前支持 API 提取格式为：单次提取数量为 `1` ，返回`txt`，换行符`\r\n`
      * 错误的 API 地址会导致插件无法获取代理 IP。

  * `listen_host`
    类型: `string`
    默认值: `127.0.0.1`
    描述: 代理服务监听的 IP 地址。
    说明:

      * `127.0.0.1` 表示代理服务只监听本地连接。
      * 通常情况下，保持默认值即可。公网使用请改为`0.0.0.0`
      * 修改此配置后，需要重启代理服务才能生效。

  * `local_port`
    类型: `int`
    默认值: `8888`
    描述: 本地代理服务监听的端口号。
    说明:

      * 请选择一个未被其他程序占用的端口。
      * 修改此配置后，需要重启代理服务才能生效。

  * `validation_url`
    类型: `string`
    默认值: `"http://www.baidu.com"`
    描述: 用于验证代理 IP 有效性的 URL。
    说明:

      * 插件会尝试通过代理访问此 URL 来判断 IP 是否可用。
      * 建议使用一个稳定且常用的网站或直接填写请求目标地址。

  * `validation_interval`
    类型: `int`
    默认值: `60`
    描述: IP 验证间隔，单位为秒
    说明:

      * 一个 IP 被验证有效后，在此时间内不会重复验证。
      * 此值应小于 IP 失效时间，以确保代理 IP 的有效性。

  * `validation_timeout`
    类型: `int`
    默认值: `5`
    描述: 验证请求的超时时间，单位为秒。
    说明:

      * 访问 `validation_url` 时，如果超过此时间未响应，则判定代理 IP 无效。
      * 适当调整此值可以应对网络状况不佳的情况。
      * 设置过长可能会导致IP失效时响应变慢，请合理设置。

  * `ip_expiration_time`
    类型: `int`
    默认值: `300`
    描述: IP 绝对失效时间，单位为秒。
    说明:

      * 一个 IP 从获取开始，无论是否有效，超过此时间都将被强制丢弃并获取新 IP。
      * 设置为 `0` 则永不强制失效，请根据代理服务商提供的IP有效时间上限填写。

## 使用教程

安装并配置好 API 和相关参数后，本地使用修改监听地址为 **127.0.0.1** ,公网使用监听 **0.0.0.0** ，自行放行对应监听端口;

重载并启动本插件即可启动代理，使用指令`/代理状态`可查看代理状态，日志等级修改为`Debug`可查看更多日志信息；

本地代理地址为:`http://127.0.0.1:监听端口`,

公网代理地址为:`http://服务器公网ip:监听端口`.

**公网使用请自行配置安全组ip白名单，避免被恶意盗刷**

## 指令列表

**注意：** 以下所有指令都需要Astrbot管理员权限才能执行。

### 服务控制

  * **开启代理**

      * 主指令: `开启代理`
      * 别名: `启动代理`, `代理开启`
      * 作用: 启动代理服务。

  * **关闭代理**

      * 主指令: `关闭代理`
      * 别名: `代理关闭`, `取消代理`
      * 作用: 停止代理服务。

  * **切换IP**

      * 主指令: `切换IP`
      * 作用: 强制插件获取并切换到一个新的代理IP，并验证其有效性。

  * **查看状态**

      * 主指令: `代理状态`
      * 作用: 显示插件的详细运行状态，包括是否运行、监听地址、当前IP、**总流量限制、总使用流量、剩余流量、今日使用流量、历史每日平均流量以及预计可用天数**。

### 流量管理

  * **设置总流量**

      * 主指令: `设置总流量 <流量大小>`
      * 示例: `/设置总流量 5GB`, `/设置总流量 1000MB`
      * 作用: 设置代理服务的总流量。当总使用流量达到此限制时，代理服务将停止。

  * **设置已使用流量**

      * 主指令: `设置已使用流量 <流量大小>`
      * 示例: `/设置已使用流量 200MB`, `/设置已使用流量 1TB`
      * 作用: 手动调整当前已使用的总流量数据。方便管理使用情况。

### 配置修改

  * **修改代理API**

      * 主指令: `修改代理API <API地址>`
      * 作用: 更新用于获取代理IP的API地址。

  * **修改监听地址**

      * 主指令: `修改监听地址 <IP地址>`
      * 作用: 修改本地代理服务监听的IP地址。修改后需重启代理服务生效。

  * **修改监听端口**

      * 主指令: `修改监听端口 <端口号>`
      * 作用: 修改本地代理服务监听的端口号。修改后需重启代理服务生效。

  * **修改测试url**

      * 主指令: `修改测试url <URL地址>`
      * 作用: 更新用于验证代理IP有效性的URL。

  * **修改IP失效时间**

      * 主指令: `修改IP失效时间 <秒数>`
      * 作用: 设置代理IP的绝对失效时间。设置为`0`则永不强制失效。